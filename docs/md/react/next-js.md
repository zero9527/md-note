# ç©ç©æœåŠ¡ç«¯æ¸²æŸ“ä¹‹ Next.js

## å‰è¨€
åŸºäºReactçš„æœåŠ¡ç«¯æ¸²æŸ“SSRæ¡†æ¶ [Next.js](https://nextjs.org/learn/basics/getting-started)ï¼Œ
åŸºäºVueçš„æœåŠ¡ç«¯æ¸²æŸ“SSRæ¡†æ¶ [Nuxt.js](https://zh.nuxtjs.org/guide/installation)ã€‚ 

### ä¸ºä»€ä¹ˆéœ€è¦æœåŠ¡ç«¯æ¸²æŸ“ï¼Ÿ
* **å‡å°‘é¦–å±ç™½å±æ—¶é—´**

* **SEO**ï¼šSearch Engine Optimization å³æœç´¢å¼•æ“ä¼˜åŒ–ï¼›   
ç®€å•è¯´å°±æ˜¯ï¼Œç½‘é¡µåœ¨è¢«è¯·æ±‚çš„æ—¶å€™ï¼Œä»æœåŠ¡å™¨å‘å‡ºçš„å†…å®¹å¯ä»¥è¢«æœç´¢å¼•æ“çš„çˆ¬è™«çˆ¬åˆ°æ•°æ®ï¼Œ    
è¿™ä¸ªæ—¶å€™ä»æœç´¢å¼•æ“æœç´¢çš„å…³é”®å­—åŒ…å«åœ¨è¿™äº›å†…å®¹ä¸­ï¼Œé‚£ä¹ˆè¿™ä¸ªç½‘å€çš„ä¿¡æ¯å°±æ›´å®¹æ˜“æ˜¾ç¤ºåœ¨æœç´¢ç»“æœä¸­~

* **å®¢æˆ·ç«¯æ¸²æŸ“**ï¼šå‰ç«¯SPAçš„å‡ºç°ï¼Œå¤§éƒ¨åˆ†çš„é¡µé¢å†…å®¹åœ¨æµè§ˆå™¨ç«¯é€šè¿‡å¼‚æ­¥è¯·æ±‚æ‹¿åˆ°æ•°æ®ï¼Œç„¶åæ¸²æŸ“ç”Ÿæˆï¼›   
è€Œä»æœåŠ¡å™¨å‘å‡ºçš„åªæ˜¯ä¸€ä¸ªæ²¡æœ‰å†…å®¹çš„ç©ºå£³ï¼Œæœç´¢å¼•æ“è‡ªç„¶çˆ¬ä¸åˆ°ä¸œè¥¿~

* **æœåŠ¡ç«¯æ¸²æŸ“**ï¼šä»¥å‰çš„åç«¯MCVæ¡†æ¶å°±æ˜¯ä½¿ç”¨æ¨¡æ¿åœ¨æœåŠ¡å™¨ä¸Šå°†å†…å®¹ç”Ÿæˆï¼Œç„¶åæµè§ˆå™¨æ¥æ”¶åˆ°æ•°æ®ç›´æ¥æ¸²æŸ“å°±å¯ä»¥äº†ï¼›     
è¿™ä¸ªæ—¶å€™ç½‘é¡µçš„å†…å®¹å·²ç»è·Ÿéšç½‘ç«™è¿‡æ¥ï¼Œä¸»è¦å†…å®¹ä¸éœ€è¦é¢å¤–çš„å¼‚æ­¥è¯·æ±‚è·å–ï¼Œ  
æœç´¢å¼•æ“çš„çˆ¬è™«å°±å¯ä»¥çˆ¬åˆ°è¿™äº›éå¼‚æ­¥è¯·æ±‚çš„æ•°æ®~

* **å‰ç«¯æ¡†æ¶çš„SSR**ï¼šä¸»è¦æ˜¯ **å‰åç«¯åŒæ„**ã€**å¾®æœåŠ¡æ¥å£èšåˆ** ç­‰ï¼›å½“ç„¶åªæ˜¯å½“ä½œæ¸²æŸ“å±‚æ˜¯æœ€ç®€å•çš„ï¼Œæ¥å£è¿™äº›å°±ç”±åç«¯å¤§ä½¬è´Ÿè´£å§ï¼›   
å¦‚ React/Vue/Angular éƒ½æœ‰ä½¿ç”¨ Node.js åœ¨æœåŠ¡ç«¯æ¸²æŸ“æ•°æ®çš„æ¡†æ¶ï¼›    
å‰ç«¯ä¹Ÿå¯ä»¥ç»§ç»­ä½¿ç”¨ React/Vue/Angular æ¡†æ¶ï¼Œåªæ˜¯æŸäº›æ•°æ®æ”¾åœ¨äº†æœåŠ¡ç«¯ç”Ÿæˆ

---

æºç çœ‹ğŸ‘‡[è¿™é‡Œ](https://github.com/zero9527/next-test)

å¯ä»¥çœ‹åˆ°ï¼Œä»æœåŠ¡å™¨è¿‡æ¥çš„æ—¶å€™å·²ç»æœ‰å†…å®¹äº†ï¼š
![](../static/images/next-js-0.png)

åç»­çš„è·¯ç”±å˜åŒ–å°±ç›¸å½“äº **å•é¡µé¢SPA** äº†ï¼Œä½†æ˜¯åœ¨æŸä¸ªè·¯ç”±ä¸‹åˆ·æ–°ï¼Œé‚£ä¹ˆè¿™ä¸ªè·¯ç”±ä¹Ÿå°±æ˜¯ **æœåŠ¡ç«¯æ¸²æŸ“** çš„


## 1ã€src ç›®å½•ç»“æ„
```
.
â”œâ”€â”€ components
â”‚   â”œâ”€â”€ header
â”‚   â”œâ”€â”€ hello-world
â”‚   â””â”€â”€ layout
â”œâ”€â”€ pages
â”‚   â”œâ”€â”€ _app.tsx
â”‚   â”œâ”€â”€ _error.tsx
â”‚   â”œâ”€â”€ about.tsx
â”‚   â”œâ”€â”€ detail.tsx
â”‚   â””â”€â”€ index.tsx
â”œâ”€â”€ store
â”‚   â”œâ”€â”€ home.ts
â”‚   â””â”€â”€ index.ts
â””â”€â”€ styles
    â”œâ”€â”€ _error.scss
    â”œâ”€â”€ about.scss
    â”œâ”€â”€ detail.scss
    â””â”€â”€ index.scss
```

![](../static/images/next-js-1.png)

## 2ã€npm script
tsc éœ€è¦å®‰è£…
```
yarn install typescript -g
```


## 3ã€é¡µé¢ head
è®¾ç½®é¡µé¢ head
```js
import Head from 'next/head';

const Header = () => (
  <Head>
    <title>Next.js test</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
  </Head>
);
```

![](../static/images/next-js-3.png)

å¯ä»¥åœ¨éœ€è¦ä¿®æ”¹é¡µé¢ head çš„åœ°æ–¹ä½¿ç”¨ï¼Œå¦‚ `/about` éœ€è¦ä¿®æ”¹ é¡µé¢`title` ä¸º aboutï¼›<br> æ˜¯å¢é‡ä¿®æ”¹çš„æ–¹å¼ï¼šæ²¡æœ‰åˆ™æ·»åŠ ï¼Œæœ‰åˆ™ä¿®æ”¹
```jsx
// ...
<Head>
  <title>about</title>
</Head>
// ...
```


## 4ã€è·¯ç”±
`pages` ç›®å½•ä¸‹è‡ªåŠ¨ç”Ÿæˆè·¯ç”±ï¼Œå±‚çº§åªèƒ½æ˜¯ä¸€å±‚ å¦‚ä¸‹ï¼š
```js
// ç¬¬ä¸€ç§å†™æ³•
pages/home.tsx
pages/detail.tsx

styles/home.scss
styles/detail.scss

// è€Œä¸æ˜¯
// ç¬¬äºŒç§å†™æ³•
pages/home/index.tsx
pages/home/home.scss
```

> * `pages/` ä¸‹ ä¸èƒ½æ˜¯æ–‡ä»¶å¤¹ï¼ˆæ­£å¸¸æ¥è¯´è¿˜æœ‰ä¸ª cssï¼Œä½†æ˜¯ä½¿ç”¨æ–‡ä»¶å¤¹çš„è¯ï¼Œå¼€å‘é˜¶æ®µæ­£å¸¸ï¼Œbuild æ—¶ ä¼šæŠ¥ scss æ–‡ä»¶ä¸æ˜¯ React ç»„ä»¶ã€‚ã€‚ã€‚æ‰€ä»¥åœ¨å¤–é¢æ–°å»º `styles` æ–‡ä»¶å¤¹ï¼Œæ”¾å„è‡ªè·¯ç”±ç»„ä»¶çš„ scss æ–‡ä»¶ï¼‰
> * å…¶ä»–æ–‡ä»¶å¤¹å¦‚ `components` ä¸ä¼šæŠ¥é”™ï¼Œå¯ä»¥ä½¿ç”¨ç¬¬äºŒç§å†™æ³•ï¼Œæ ·å¼è·Ÿç»„ä»¶åœ¨ä¸€ä¸ªæ–‡ä»¶å¤¹

### 4.1 Link ç»„ä»¶ï¼š
* href: è·¯ç”±ï¼Œå¦‚ `href="about"` ï¼Œåˆ™ä¼šæ¸²æŸ“ `page/about.tsx` çš„å†…å®¹
* as: å°† `href` é‡å‘½åç„¶åæµè§ˆå™¨åœ°å€æ˜¾ç¤ºçš„æ˜¯è¿™ä¸ªURLï¼›   
hrefçš„è·¯ç”±å¿…é¡»æ­£ç¡®ï¼Œéœ€è¦æœ‰ä¸€ä¸ªå®é™…ä¸Šåœ¨ page ç›®å½•ä¸­å­˜åœ¨çš„æ–‡ä»¶
* prefetch: é¢„å–ï¼Œå½“å‰é¡µé¢ä¼šç”¨åˆ°

#### href/as
å¦‚ä¸‹å°†æµè§ˆå™¨URLæ˜¾ç¤ºä¸º about1ï¼Œå¦‚æœæœåŠ¡ç«¯ä¸å¦å¤–æ‹¦æˆªè·¯ç”±çš„è¯ï¼Œå®é™…ä¸Šæ¸²æŸ“çš„æ˜¯ pages/about.tsx æ–‡ä»¶ï¼Œå®é™…çš„è·¯ç”±ä¹Ÿæ˜¯å¦‚æ­¤
```js
import Link from 'next/link';

<Link href="/about">
  <a>About</a>
</Link>
```

å¦‚æœè®¾ç½®äº† as åˆ«åï¼Œå¹¶ä¸”ä¸åŸæ¥çš„è·¯ç”±ä¸ä¸€æ ·äº†ï¼Œéœ€è¦åœ¨æœåŠ¡ç«¯å¦å¤–è®¾ç½®è·¯ç”±ï¼›

å¦‚ä¸‹ï¼š
* å®¢æˆ·ç«¯

```js
// ...
  return (
    <div>
      <Link href="/detail?id=123" as="/detail/123">
        <a style={linkStyle}>Detail</a>
      </Link>
    </div>
  )
// ...
```

* æœåŠ¡ç«¯

```js
// server.ts
  server.get('/detail/:id', (req: Req, res: http.ServerResponse) => {
    app.render(req, res, '/detail', {
      id: req.params.id
    })
  });
```

#### prefetch
æ¥è‡ª[æ–‡æ¡£](https://nextjs.org/docs#prefetching-pages)

æœ‰äº›æ“ä½œå¯èƒ½éœ€è¦å»¶è¿Ÿï¼Œä½†å¯ä»¥ä½¿ç”¨ prefetch é¢„å–æ•°æ®

* Link ç»„ä»¶

```jsx
<Link href="/about" prefetch={true}>
  <a>About</a>
</Link>
```

* å‘½ä»¤å¼

```jsx
import { withRouter } from 'next/router';

function MyLink({ router }) {
  return (
    <div>
      <a onClick={() => setTimeout(() => router.push('/dynamic'), 100)}>
        A route transition will happen after 100ms
      </a>
      {// but we can prefetch it!
      router.prefetch('/dynamic')}
    </div>
  );
}

export default withRouter(MyLink);
```

#### push/replace
* å¯¹è±¡

```jsx
import Router from 'next/router'

const handler = () => {
  Router.push({
    pathname: '/about',
    query: { name: 'Zeit' },
  })
}

function ReadMore() {
  return (
    <div>
      Click <span onClick={handler}>here</span> to read more
    </div>
  )
}

export default ReadMore
```

### 4.2 éè·¯ç”±ç»„ä»¶è·å–è·¯ç”±å‚æ•°
è¿™ä¸ªå’Œ React ä¸€æ ·ï¼Œä½¿ç”¨ `withRouter` è·å–è·¯ç”±å‚æ•°ï¼Œä¸è¿‡è¿™ä¸ªæ˜¯ä» `next/router` å¯¼å‡ºçš„ï¼›å‡½æ•°ç»„ä»¶ä¹Ÿå¯ä»¥ä½¿ç”¨ `useRouter` 
```js
// src/components/header/index.tsx
import Link from 'next/link';
import Head from 'next/head';
import React from 'react'; 
import styles from './header.scss';

const Header = () => {
  return (
    <div>
      <Head>
        <title>Next.js test</title>
        <meta name="viewport" content="width=device-width,initial-scale=1" />
      </Head>
      
      <Link href="/">
        <a className={styles.tag}>Home</a>
      </Link>
      <Link href="/about">
        <a className={styles.tag}>About</a>
      </Link>
      <Link href="/detail?id=123" as="/detail/123">
        <a className={styles.tag}>Detail</a>
      </Link>
    </div>
  )
};

export default Header;
```

### 4.3 è·¯ç”±è½¬æ¢
* å°† `href="/detail?id=123"` çš„ **queryæŸ¥è¯¢çš„URL** è½¬æ¢ä¸º `as="/detail/123"` çš„ **params å¼ URL**ï¼›     
href/as æ˜¯é™æ€çš„ï¼Œæœ‰éœ€è¦çš„è¯åŠ¨æ€ç”Ÿæˆ `<Link>` å³å¯

![](../static/images/next-js-4.3.png)

```js
import Link from 'next/link';

<Link href="/detail?id=123" as="/detail/123">
  <a className={styles.tag}>Detail</a>
</Link>
```

* æœåŠ¡ç«¯åŒ¹é…URLä¸º `/detail/:id` çš„è·¯ç”±ï¼Œ     
æ·»åŠ  `params å‚æ•°`ï¼Œç„¶åæ¸²æŸ“ `/detail` å¯¹åº”çš„ `page/detail.tsx` æ–‡ä»¶;  
å¦‚æœä¸åœ¨æœåŠ¡ç«¯è®¾ç½®å¯¹åº”çš„è·¯ç”±æ‹¦æˆªçš„è¯ï¼Œåˆ·æ–°ä¼šå¯¼è‡´404

```ts
// server.ts
// ...

function serverRun() {
  const server = express();
  // apiæ¥å£
  const controllers = require('./server/controller');
  const apiRoute = ''; // '/web';
  server.use(apiRoute, controllers);

  // åŒ¹é…URLä¸º `/` çš„è·¯ç”±ï¼Œç„¶åæ¸²æŸ“ `/` å¯¹åº”çš„ `page/index.tsx` æ–‡ä»¶
  server.get('/', (req: Req, res: http.ServerResponse) => {
    app.render(req, res, '/')
  });

  // åŒ¹é…URLä¸º `/about` çš„è·¯ç”±ï¼Œç„¶åæ¸²æŸ“ `/about` å¯¹åº”çš„ `page/about.tsx` æ–‡ä»¶
  server.get('/about', (req: Req, res: http.ServerResponse) => {
    app.render(req, res, '/about')
  });

  // åŒ¹é…URLä¸º `/detail/:id` çš„è·¯ç”±ï¼Œæ·»åŠ  `params å‚æ•°`ï¼Œç„¶åæ¸²æŸ“ `/detail` å¯¹åº”çš„ `page/detail.tsx` æ–‡ä»¶
  server.get('/detail/:id', (req: Req, res: http.ServerResponse) => {
    app.render(req, res, '/detail', {
      id: req.params.id
    })
  });

  server.get('*', (req: http.IncomingMessage, res: http.ServerResponse) => {
    return handle(req, res);
  });

  server.listen(3000, (err: any) => {
    if (err) throw err;
    console.log('> Ready on http://localhost:3000');
  });
}
```

### 4.4 è·¯ç”±æ–¹æ³•
#### è·¯ç”±æ‹¦æˆª Router.beforePopState
åœ¨æµè§ˆå™¨ç«¯æ‰§è¡Œï¼Œéœ€è¦ç»„ä»¶åŠ è½½å®Œ `componentDidMount/useEffect` æ‰§è¡Œï¼Œä¸ç„¶ä¼šæŠ¥é”™
```js
// src/pages/index.tsx
import Link from 'next/link';
import /* Router, */ { useRouter } from 'next/router';
import React, { useEffect } from 'react';
import Layout from '@/components/layout';
import styles from '@/styles/index.scss';

/**
 * é¦–é¡µï¼Œè·¯ç”±ä¸º '/'
 * @param props 
 */
const Home = () => {
  const router = useRouter();

  useEffect(() => {
    // è·¯ç”±æ‹¦æˆªï¼Œä¼šå½±å“æµè§ˆå™¨å‰è¿›åé€€çš„æ¸²æŸ“ç»“æœ
    // Router.beforePopState(({ url, as, options }: any) => {
    //   console.log('url: ', url);
    //   console.log('as: ', as);
    //   console.log('options: ', options);
      
    //   if (as === '/about') {
    //     console.log('about');
    //     return true;
    //   }
    //   return true;
    // });
  });

  return (
    <Layout>
      <h1>{router.query.title}</h1>
      <img className={styles.img} src="/static/images/4k-wallpaper-alps-cold-2283757.jpg" />
      <div className={styles.content}>
        <p>
          This is our blog post.
          Yes. We can have a <Link href="/link"><a>link</a></Link>.
          And we can have a title as well.
        </p>
        <h3>This is a title</h3>
        <p>And here's the content.</p>
      </div>
    </Layout>
  );
};

export default Home;
```

### 4.5 Router äº‹ä»¶
#### ç›‘å¬è·¯ç”±çš„å†…éƒ¨äº‹ä»¶ï¼š

* routeChangeStart(url) - è·¯ç”±å¼€å§‹å˜åŒ–çš„æ—¶å€™è§¦å‘
* routeChangeComplete(url) - è·¯ç”±å®Œæˆå˜åŒ–ä¹‹åè§¦å‘
* routeChangeError(err, url) - è·¯ç”±å˜åŒ–å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘
* beforeHistoryChange(url) - æ”¹å˜æµè§ˆå™¨å†å²çºªå½•ä¹‹å‰è§¦å‘
* hashChangeStart(url) - hash å¼€å§‹å˜åŒ–çš„æ—¶å€™è§¦å‘
* hashChangeComplete(url) - hashå®Œæˆå˜åŒ–ä¹‹åè§¦å‘

ç¤ºä¾‹ï¼š
```js
import Router from 'next/router';

const handleRouteChange = url => {
  console.log('App is changing to: ', url);
};

Router.events.on('routeChangeStart', handleRouteChange);
```

#### è·¯ç”±è·³è½¬
```js
// æ­£å¸¸è·¯ç”±è·³è½¬ï¼Œåœ¨abouté¡µé¢è·å–è·¯ç”±ä¿¡æ¯çš„æ—¶å€™ï¼Œidä¸ºa11ï¼Œ
// åˆ·æ–°é¡µé¢åˆ™idä¸ºasssï¼Œæ‰€ä»¥å°½é‡äºŒè€…ä¸€è‡´ï¼Œé¿å…ä¸å¿…è¦çš„é—®é¢˜
Router.push('/about?id=a11', '/about/asss')
```
* **Shallow Routingï¼šæµ…è·¯ç”±**

ä¸æ‰§è¡Œ getInitialProps çš„æƒ…å†µä¸‹ä¿®æ”¹é¡µé¢ URL,
```js
Router.push('/about?id=a11', '/about/asss', { shallow: true });
```

## 5ã€App

_app ç»„ä»¶ä¸ä¼šè¢«é”€æ¯ï¼Œé™¤éæ‰‹åŠ¨åˆ·æ–°
```js
// src/pages/_app.tsx
import React from 'react';
import { NextComponentType } from "next";
import { Router } from 'next/router';
import App, { AppProps } from 'next/app';

interface Props {
  Component: NextComponentType,
  pageProps: AppProps,
  router: Router
}

/**
 * App 
 */
class myApp extends App<Props> {

  public constructor(props: Props) {
    super(props);
  }
  
  public componentDidUpdate() {
    console.log('router: ', this.props.router);
  }
  
  public componentDidMount() {
    console.log('router: ', this.props.router);
  }

  public render() {
    const { Component, pageProps } = this.props;

    return (
      <React.Fragment>
        <Component {...pageProps} />
      </React.Fragment>
    );
  }
}

export default myApp;
```

## 6ã€ç»„ä»¶
### 6.1 getInitialProps å±æ€§ï¼š
æ¥æ”¶ä¸€ä¸ªæ–¹æ³•ï¼Œå¯ä»¥åœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢è·å–æ•°æ®ï¼Œåœ¨æœåŠ¡ç«¯æ¸²æŸ“ï¼›åªèƒ½åœ¨ pages/ ä¸‹çš„ç»„ä»¶ä½¿ç”¨ [æ–‡æ¡£](https://nextjs.org/docs#fetching-data-and-component-lifecycle)

**åœ¨å½“å‰è·¯ç”±åˆ·æ–°æ‰ä¼šåœ¨æœåŠ¡ç«¯æ‰§è¡Œï¼Œå¦‚æœæ˜¯ä»å…¶ä»–è·¯ç”±è·³è½¬è¿‡æ¥çš„ï¼Œæ²¡æœ‰åˆ·æ–°é¡µé¢å°±ä¼šåœ¨æµè§ˆå™¨ç«¯æ‰§è¡Œçš„ï¼›**

```js
// src/pages/detail.tsx
import Head from 'next/head';
import { useRouter } from 'next/router';
import React from 'react';
import { inject, observer } from 'mobx-react';
import { homeStoreType } from '@/store/home';
import { Button, Row } from 'antd';
import Layout from '@/components/layout';
import styles from '@/styles/detail.scss';

function Detail(props: any) {
  const router = useRouter();
  const homeStore: homeStoreType = props.homeStore;

  return (
    <Layout>
      <Head>
        <title>Detail</title>
      </Head>
      <p className={styles.detail}>This is the detail page!</p>
      id: { router.query.id }
      <Row>
        count: { homeStore.count }
      </Row>
      <Button 
        onClick={() => homeStore.setCount(homeStore.count+1)}
      >count++</Button>
    </Layout>
  );
}

Detail.getInitialProps = async function(context: any) {
  /**
   * åœ¨å½“å‰è·¯ç”±åˆ·æ–°çš„è¯ï¼Œcontext.req ä¸ºçœŸï¼ŒæœåŠ¡ç«¯æ‰æœ‰ req/resï¼Œåœ¨å‘½ä»¤è¡Œæ‰“å° 'broswer'ï¼›
   * å¦‚æœæ˜¯å…¶ä»–è·¯ç”±è·³è½¬è¿‡æ¥æ²¡æœ‰åˆ·æ–°é¡µé¢çš„è¯ï¼Œcontext.req ä¸ºå‡ï¼Œåœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰“å°,
   * æ­¤æ—¶ document.title æ˜¯ è·³è½¬ä¹‹å‰çš„é¡µé¢ titleï¼›
   */
  console.log('render-type: ', context.req ? 'server' : 'broswer');

  return {
    // data: 'detail'
  };
}

const DetailWithMobx = inject('homeStore')(
  observer(Detail)
);

export default DetailWithMobx;
```

æ¥æ”¶çš„æ–¹æ³•æœ‰ä¸€ä¸ªå½¢å‚ `context = { pathname, query, asPath, req, res, err }`ï¼š

* pathname: URL pathname ä¸­çš„å›ºå®šçš„éƒ¨åˆ†ï¼Œå¦‚ å®šä¹‰çš„`/post/:id`ï¼Œåˆ™è¿™é‡Œpathnameä¸º`/post`
* query: URLçš„æŸ¥è¯¢å‚æ•°çš„å¯¹è±¡
* asPath - å®šä¹‰çš„è·¯ç”±ï¼Œå¦‚ `/post/:id`
* req: HTTP request object (server only)
* res: HTTP response object (server only)
* err: æ¸²æŸ“æœŸé—´çš„æŠ¥é”™

### 6.2 åŠ¨æ€ import
ä½¿ç”¨ `dynamic` å’Œ `import()` å®ç°åŠ¨æ€ç»„ä»¶ï¼›     
dynamic ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œloading å­—æ®µæ˜¯åŠ è½½å®Œæˆå‰çš„ loading

```js
// src/components/about.tsx
import dynamic from 'next/dynamic';
import Head from 'next/head';
import React from 'react';
import Layout from '@/components/layout';
import styles from '@/styles/about.scss';

const Hello = dynamic(
  () => import('../components/hello-world/index'),
  { loading: () => <p>...</p> }
);

function About() {
  return (
    <Layout>
      <Head>
        <title>about</title>
      </Head>
      <p className={styles.about}>This is the about page</p>
      <Hello />
    </Layout>
  );
}

// About.getInitialProps = async function(context: any) {
//   return {
//     data: 'about'
//   };
// }

export default About;
```


## 7ã€è·¯å¾„åˆ«å
ä½¿ç”¨ `babel-plugin-module-alias`ï¼Œç›´æ¥é…ç½® webpack æ˜¯æ— æ•ˆçš„

```shell
yarn add babel-plugin-module-alias -D
```

* é…ç½® .babelrc

```json
{
  "plugins": [
    ["module-alias", { "src": "./src", "expose": "@" }]
  ],
  "presets": [
    "next/babel",
  ]
}
```

* tsconfig.json

```json
{
  "compilerOptions": {
    ...
    "baseUrl": "src",
    "paths": {
      "@/*": ["./*"]
    },
  },
  ...
}
```

## 8ã€ä½¿ç”¨ SCSS
**å®˜æ–¹æ’ä»¶ï¼š**
[@zeit/next-sass](https://github.com/zeit/next-plugins/tree/master/packages/next-sass)

### 8.1 SASS
#### å®‰è£…
```
npm install --save @zeit/next-sass node-sass
```
æˆ–
```
yarn add @zeit/next-sass node-sass
```

#### é…ç½®
é…ç½®åï¼Œä½¿ç”¨è·Ÿreacté‡Œé¢ä½¿ç”¨CSS modulesä¸€æ ·
```js
// next.config.js
const withSass = require('@zeit/next-sass')
module.exports = withSass({
  cssModules: true, // é»˜è®¤ falseï¼Œå³å…¨å±€æœ‰æ•ˆ
  cssLoaderOptions: {
    importLoaders: 1,
    localIdentName: "[local]___[hash:base64:5]",
  }
})
```

æˆ–è€…è‡ªå®šä¹‰
```js
// next.config.js
const withSass = require('@zeit/next-sass')
module.exports = withSass({
  webpack(config, options) {
    return config
  }
})
```

#### ä½¿ç”¨ postcss
é¡¹ç›®æ ¹ç›®å½•ä¸‹ï¼Œæ–°å»ºä¸€ä¸ªæ–‡ä»¶ postcss.config.js
```js
// postcss.config.js
module.exports = {
  plugins: {
    'autoprefixer': true
  }
}
```

## 9ã€antd
å‚è€ƒè¿™ä½å¤§ä½¬çš„ [æ–‡ç« ](https://www.cnblogs.com/1wen/p/10793868.html)ï¼Œ
ä¸»è¦å°±æ˜¯ `cssModules` å’Œ `antdæŒ‰éœ€åŠ è½½` ä¸€èµ·ä½¿ç”¨çš„é—®é¢˜ï¼Œå…¶ä»–çš„æŒ‰ç…§ antd å®˜ç½‘çš„æå°±å¯ä»¥ï¼Œantd-mobile åªè¦å°† ç›¸åº”çš„antd æ”¹ä¸º antd-mobile å°±å¯ä»¥äº†

### .babelrc
```
{
  "plugins": [
    // "transform-decorators-legacy",
    ["@babel/plugin-proposal-decorators", { "legacy": true }],
    ["module-alias", { "src": "./src", "expose": "@" }],
    ["import", { "libraryName": "antd", "style": "css" }]
  ],
  "presets": [
    "next/babel",
  ]
}
```

### next.config.js
ä»¥ä¸‹æ˜¯å…¬å…±é…ç½®ï¼Œä¼šåˆå¹¶åˆ° next.config.js çš„é…ç½®ä¸­
```js
// config/config.common.js
const path = require('path');
const cssLoaderGetLocalIdent = require('css-loader/lib/getLocalIdent.js');
// const isProd = process.env.NODE_ENV === 'production';

if (typeof require !== 'undefined') {
  require.extensions['.css'] = file => { }
}

/* å…¬å…±é…ç½® */
let configCommon = {
  // assetPrefix: isProd ? 'https://cdn.mydomain.com' : '',
  crossOrigin: 'anonymous',
  cssModules: true,
  cssLoaderOptions: {
    importLoaders: 1,
    localIdentName: "[local]___[hash:base64:5]",
    getLocalIdent: (context, localIdentName, localName, options) => {
      const hz = context.resourcePath.replace(context.rootContext, '');
      // æ’é™¤ node_modules ä¸‹çš„æ ·å¼
      if (/node_modules/.test(hz)) {
        return localName;
      }
      return cssLoaderGetLocalIdent(context, localIdentName, localName, options);
    }
  },
  distDir: 'next-build', // æ„å»ºè¾“å‡ºç›®å½•ï¼Œé»˜è®¤ '.next'
  generateEtags: true, // æ§åˆ¶ç¼“å­˜çš„ etagï¼Œé»˜è®¤ true
  pageExtensions: ['tsx', 'jsx', 'js', 'scss'], // pagesæ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶åç¼€
  webpack(config){
    if(config.externals){
      // è§£å†³ æ‰“åŒ…cssæŠ¥é”™é—®é¢˜
      const includes = [/antd/];
      config.externals = config.externals.map(external => {
        if (typeof external !== 'function') return external;
        return (ctx, req, cb) => {
          return includes.find(include =>
            req.startsWith('.')
              ? include.test(path.resolve(ctx, req))
              : include.test(req)
          )
            ? cb()
            : external(ctx, req, cb);
        };
      });
    }
    return config;
  }
};

module.exports = configCommon;
```


## 10ã€çŠ¶æ€ç®¡ç† MobX
è·Ÿè¿™ç¯‡ [React+Typescript](https://juejin.im/post/5d3faa3a5188255d2e32c6e3) çš„å•é¡µé¢SPAé¡¹ç›®é‡Œçš„å·®ä¸å¤šï¼Œåªæ˜¯æœåŠ¡ç«¯æ¸²æŸ“ æ²¡æœ‰ `window`ï¼›æ‰€ä»¥ç¼“å­˜è¿™é‡Œå…ˆåˆ¤æ–­ä¸€ä¸‹æ˜¯å¦æµè§ˆå™¨ï¼Œç„¶åå†å»ä½¿ç”¨æµè§ˆå™¨ API( `sessionStorage` )ï¼›

ä¸è¿‡åˆ·æ–°ä¼šæœ‰ä¸€ä¸ªæ•°æ®å˜åŒ–çš„è¿‡ç¨‹ï¼Œå› ä¸ºå®é™…ä¸Š `_app.txs` æ˜¯åœ¨æœåŠ¡ç«¯æ¸²æŸ“çš„ï¼Œç¼“å­˜æ˜¯åœ¨æµè§ˆå™¨æ¢å¤çš„ï¼Œæœ‰ä¸ªæ—¶é—´å·®ï¼Œè€Œä¸”ä¼šæœ‰è­¦å‘Š(å…¶å®å¯ä»¥å¿½ç•¥ï¼ŒæœåŠ¡å™¨è·Ÿå®¢æˆ·ç«¯çš„è¿™ä¸ªç¼“å­˜ä¸éœ€è¦åŒæ­¥ï¼Œä½¿ç”¨ `sessionStorage` ä¹Ÿæ˜¯å› ä¸ºä¸éœ€è¦é•¿ä¹…ç¼“å­˜ï¼Œå½“ç„¶å¯ä»¥æ ¹æ®éœ€è¦æ”¹ä¸º `localStorage` )ï¼Œæ ¹æ®éœ€æ±‚å–èˆå§

> å•é¡µé¢SPA å› ä¸ºæ˜¯åœ¨æµè§ˆå™¨æ¸²æŸ“æ‰€ä»¥ä¸ä¼šæœ‰è¿™æ ·çš„é—®é¢˜

![](../static/images/next-js-10.png)
```js
const isBroswer: boolean = process.browser;
```

### 10.1 é¡¹ç›®å…¥å£
```js
// src/pages/_app.tsx
import { NextComponentType } from "next";
import { Router } from 'next/router';
import App, { AppProps } from 'next/app';
import React from 'react';
import { Provider } from 'mobx-react';
import store from '../store';

interface Props {
  Component: NextComponentType,
  pageProps: AppProps,
  router: Router
}

/**
 * App 
 */
class myApp extends App<Props> {

  public constructor(props: Props) {
    super(props);
  }
  
  public componentDidUpdate() {
    console.log('router: ', this.props.router);
  }
  
  public componentDidMount() {
    console.log('router: ', this.props.router);
  }

  public render() {
    const { Component, pageProps } = this.props;

    return (
      <React.Fragment>
        <Provider {...store}>
          <Component {...pageProps} />
        </Provider>
      </React.Fragment>
    );
  }
}

export default myApp;
```

### 10.2 æ¨¡å—
ç›‘å¬æ•°æ®ä½¿ç”¨ `autorun`ï¼Œä¼šåœ¨æ•°æ®å˜åŒ–æ—¶æ‰§è¡Œä¸€æ¬¡ï¼›ç„¶åç”¨ `toJS` å°†æ¨¡å—è½¬åŒ–ä¸º `JSå¯¹è±¡`
```js
// src/store/home.ts
import * as mobx from 'mobx';

// ç¦æ­¢åœ¨ action å¤–ç›´æ¥ä¿®æ”¹ state 
mobx.configure({ enforceActions: "observed"});
const { observable, action, computed, runInAction, autorun } = mobx;

const isBroswer: boolean = process.browser;

/**
 * æ‰€ä»¥ç¼“å­˜è¿™é‡Œå…ˆåˆ¤æ–­ä¸€ä¸‹æ˜¯å¦æµè§ˆå™¨ï¼Œç„¶åå†å»ä½¿ç”¨æµè§ˆå™¨ API( `sessionStorage` )ï¼›
 * ä¸è¿‡ä¼šæœ‰ä¸€ä¸ªé—ªç°çš„è¿‡ç¨‹ï¼Œå› ä¸ºå®é™…ä¸Š `_app.txs` æ˜¯åœ¨æœåŠ¡ç«¯æ¸²æŸ“çš„ï¼Œç¼“å­˜æ˜¯åœ¨æµè§ˆå™¨æ¢å¤çš„ï¼Œ
 * æœ‰ä¸ªæ—¶é—´å·®ï¼Œè€Œä¸”ä¼šæœ‰è­¦å‘Šï¼Œæ ¹æ®éœ€æ±‚å–èˆå§
 */
let cache = isBroswer && window.sessionStorage.getItem('homeStore');

// åˆå§‹åŒ–æ•°æ®
let initialState = {
  count: 0,
  data: {
    time: '2019-11-20'
  },
};

// ç¼“å­˜æ•°æ®
if (isBroswer && cache) {
  initialState = {
    ...initialState,
    ...JSON.parse(cache)
  }
}

class Home {
  @observable
  public count = initialState.count;

  @observable
  public data = initialState.data;

  @computed
  public get getTime() {
    return this.data.time;
  }

  @action
  public setCount = (_count: number) => {
    this.count = _count;
  }

  @action
  public setCountAsync = (_count: number) => {
    setTimeout(() => {
      runInAction(() => {
        this.count = _count;
      })
    }, 1000);
  }

  // public setCountFlow = flow(function *(_count: number) {
  //   yield setTimeout(() => {}, 1000);
  //   this.count = _count;
  // })
}

const homeStore = new Home();

// æ•°æ®å˜åŒ–åè§¦å‘ï¼Œæ•°æ®ç¼“å­˜
autorun(() => {
  const obj = mobx.toJS(homeStore);
  isBroswer && window.sessionStorage.setItem('homeStore', JSON.stringify(obj));
});

export type homeStoreType = typeof homeStore;
export default homeStore;
```

### 10.3 æ¨¡å—ç®¡ç†è¾“å‡º
```js
// src/store/index.ts
import homeStore from './home';

/**
 * ä½¿ç”¨ mobx çŠ¶æ€ç®¡ç†
 */
export default {
  homeStore
}
```

### 10.4 ç»„ä»¶ä½¿ç”¨
è¿™é‡Œæ˜¯å‡½æ•°ç»„ä»¶çš„ä½¿ç”¨ï¼Œç±»ç»„ä»¶çš„ä½¿ç”¨å¯ä»¥çœ‹ [è¿™é‡Œ](https://juejin.im/post/5d3faa3a5188255d2e32c6e3#heading-27)
```js
// src/pages/detail.tsx
import Head from 'next/head';
import { useRouter } from 'next/router';
import React from 'react';
import { inject, observer } from 'mobx-react';
import { homeStoreType } from '@/store/home';
import { Button, Row } from 'antd';
import Layout from '@/components/layout';
import styles from '@/styles/detail.scss';

function Detail(props: any) {
  const router = useRouter();
  const homeStore: homeStoreType = props.homeStore;

  return (
    <Layout>
      <Head>
        <title>Detail</title>
      </Head>
      <p className={styles.detail}>This is the detail page!</p>
      id: { router.query.id }
      <Row>
        count: { homeStore.count }
      </Row>
      <Button 
        onClick={() => homeStore.setCount(homeStore.count+1)}
      >count++</Button>
      <Button 
        onClick={() => homeStore.setCountAsync(homeStore.count+1)}
      >countAsync++</Button>
    </Layout>
  );
}

Detail.getInitialProps = async function(context: any) {
  /**
   * åœ¨å½“å‰è·¯ç”±åˆ·æ–°çš„è¯ï¼Œcontext.req ä¸ºçœŸï¼ŒæœåŠ¡ç«¯æ‰æœ‰ req/resï¼Œåœ¨å‘½ä»¤è¡Œæ‰“å° 'broswer'ï¼›
   * å¦‚æœæ˜¯å…¶ä»–è·¯ç”±è·³è½¬è¿‡æ¥æ²¡æœ‰åˆ·æ–°é¡µé¢çš„è¯ï¼Œcontext.req ä¸ºå‡ï¼Œåœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰“å°,
   * æ­¤æ—¶ document.title æ˜¯ è·³è½¬ä¹‹å‰çš„é¡µé¢ titleï¼›
   */
  console.log('render-type: ', context.req ? 'server' : 'broswer');

  return {
    data: 'detail'
  };
}

const DetailWithMobx = inject('homeStore')(
  observer(Detail)
);

export default DetailWithMobx;
```


## 11ã€æœåŠ¡ç«¯

### 11.1 server.ts
`server.ts` æ”¹åŠ¨åï¼Œéœ€è¦åœ¨å‘½ä»¤è¡Œæ‰‹åŠ¨æ‰§è¡Œ `tsc server.ts` ç”Ÿæˆ `server.js`ï¼Œæ‰èƒ½æ‰§è¡Œï¼ˆæš‚æ—¶å°±è¿™ä¹ˆæå§ï¼‰ï¼›åœ¨ npm script é‡Œé¢ç›´æ¥å†™å¥½å°±okäº†ï¼›ä¸çŸ¥é“æ€ä¹ˆè‡ªåŠ¨ç¼–è¯‘+é‡å¯æœåŠ¡

#### next(opts: object)

optsæœ‰ä»¥ä¸‹å±æ€§ï¼š
* dev (bool): æ˜¯å¦å¼€å‘ç¯å¢ƒ development - é»˜è®¤ false
* dir (string): Next é¡¹ç›®çš„ä½ç½® - é»˜è®¤ '.'
* quiet (bool): éšè—åŒ…å«æœåŠ¡å™¨ä¿¡æ¯çš„é”™è¯¯æ¶ˆæ¯ - é»˜è®¤ false
* conf (object): ä¸åœ¨ next.config.js ä¸­çš„å¯¹è±¡ä¸€æ · - é»˜è®¤ {}

```js
const next = require('next');

const dev = process.env.NODE_ENV !== 'production';
const app = next({ 
  dev,
  dir: '.',
  quiet: false,
  conf: {}
});
```

#### åŠ¨æ€èµ„æºå‰ç¼€ assetPrefix
æ¯”å¦‚æœ¬åœ°ã€çº¿ä¸Šä½¿ç”¨cdnçš„è¯èµ„æºå°±å’Œé¡µé¢çš„æœåŠ¡å™¨ä¸æ˜¯åŒä¸€å°äº†

![](../static/images/next-js-11.1.png)

```ts
// server.ts
const express = require('express');
const next = require('next');
import * as http from "http";

const dev = process.env.NODE_ENV !== 'production';
const app = next({ dev });
const handle = app.getRequestHandler();

interface Req extends http.IncomingMessage {
  params?: any,
}

app
  .prepare()
  .then(() => {
    serverRun();
  })
  .catch((ex: any) => {
    console.log(ex.stack);
    process.exit(1);
  });
  
function serverRun() {
  const server = express();
  // apiæ¥å£
  const controllers = require('./server/controller');
  const apiRoute = ''; // '/web';
  server.use(apiRoute, controllers);

  // åŒ¹é…URLä¸º `/` çš„è·¯ç”±ï¼Œç„¶åæ¸²æŸ“ `/` å¯¹åº”çš„ `page/index.tsx` æ–‡ä»¶
  server.get('/', (req: Req, res: http.ServerResponse) => {
    app.render(req, res, '/')
  });

  // åŒ¹é…URLä¸º `/about` çš„è·¯ç”±ï¼Œç„¶åæ¸²æŸ“ `/about` å¯¹åº”çš„ `page/about.tsx` æ–‡ä»¶
  server.get('/about', (req: Req, res: http.ServerResponse) => {
    app.render(req, res, '/about')
  });

  // åŒ¹é…URLä¸º `/detail/:id` çš„è·¯ç”±ï¼Œæ·»åŠ  `params å‚æ•°`ï¼Œç„¶åæ¸²æŸ“ `/detail` å¯¹åº”çš„ `page/detail.tsx` æ–‡ä»¶
  server.get('/detail/:id', (req: Req, res: http.ServerResponse) => {
    app.render(req, res, '/detail', {
      id: req.params.id
    })
  });

  server.get('*', (req: http.IncomingMessage, res: http.ServerResponse) => {
    return handle(req, res);
  });

  server.listen(3000, (err: any) => {
    if (err) throw err;
    console.log('> Ready on http://localhost:3000');
  });
}
```

### 11.2 å†™ä¸ªæ¥å£
ä½¿ç”¨é»˜è®¤çš„ express
> æœ¬æ¥æ˜¯è¦æ”¹æˆ koa çš„ï¼Œä½†æ˜¯è·¯ç”±é‚£é‡Œé¡µé¢ä¼šæ¸²æŸ“ï¼ŒæœåŠ¡ç«¯æ¸²æŸ“çš„é¡µé¢çœ‹ç½‘ç»œè¯·æ±‚ç¡®æ˜¯404ï¼Œå†…å®¹å€’æ˜¯æ¸²æŸ“å‡ºæ¥äº†(åœ¨ server-koa.ts )ã€‚ã€‚ã€‚

#### æ¨¡å—
```js
// server/controllers/user.js
const Router = require('express').Router();

Router.get('/userInfo/:id', (req, res) => {
  console.log('id: ', req.params.id);
  
  res.send({
    status: 200,
    data: {
      name: 'å°å±å­©',
      sex: 'ç”·',
      age: '3'
    },
    message: ''
  });
});

module.exports = Router;
```

#### æ¨¡å—ç®¡ç†
```js
// server/controller.js
const Router = require('express').Router();
const user = require('./controllers/user');

Router.use('/user', user);

module.exports = Router;
```

#### æŒ‚è½½åˆ° server æœåŠ¡
```js
// server.ts
// ...

function serverRun() {
  const server = express();
  // apiæ¥å£
  const controllers = require('./server/controller');
  const apiRoute = ''; // '/web';
  server.use(apiRoute, controllers);
  
  // ...
}
```

#### æ¥å£è°ƒç”¨
```js
// src/pages/about.tsx
fetch('/user/userInfo/2').then(res => res.json())
.then(res => {
  console.log('fetch: ', res);
})
```

nginx åœ¨æœ¬åœ°éƒ¨ç½²ï¼Œè¯·æ±‚è¢«ä»£ç†(`proxy_pass`)åˆ° `next-test` çš„æœåŠ¡(pm2 å¯åŠ¨)ï¼Œè¯·æ±‚å“åº”çš„æˆªå›¾ï¼š
![](../static/images/next-js-11.2.png)

## 12ã€æ„å»º
npm script: 
```js
// package.json
...
 "scripts": {
    "dev": "node server.js",
    "dev:tsc": "tsc server.ts",
    "build": "next build",
    "start": "cross-env NODE_ENV=production node server.js"
  },
...
```

å¼€å‘ç¯å¢ƒï¼š
```
yarn dev
```

æ‰“åŒ…ï¼š
```
yarn build
```
ç„¶åäº§ç”Ÿçš„ `next-build` æ–‡ä»¶å¤¹ (next-build æ˜¯é…ç½®å¥½çš„è¾“å‡ºç›®å½•)


## 13ã€éƒ¨ç½²
ä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼ŒæŠŠé¡¹ç›®æ”¾åœ¨ nginx ä¸‹æ–°å»ºçš„ html æ–‡ä»¶å¤¹ä¸‹( `/usr/local/etc/nginx/html/next-test` ) å¯åŠ¨é¡¹ç›®å’Œnginxï¼Œæµè§ˆå™¨è®¿é—®ä¸€ç›´éƒ½æ˜¯502ï¼ˆå•é¡µé¢SPAçš„å€’æ˜¯æ­£å¸¸ï¼‰ã€‚ã€‚ã€‚æ”¾åˆ°åˆ«çš„ç›®å½•ä¸‹å¯åŠ¨å°±å¯ä»¥( `/usr/local/website/next-test` )ã€‚ã€‚ã€‚ä¸çŸ¥é“æ˜¯ä¸æ˜¯ macOS çš„åŸå› ï¼Œæ‰¾æ—¶é—´åœ¨ linux ä¸Šé¢è¯•è¯•ï½
æ‰€ä»¥æŠŠé¡¹ç›®éƒ½æ”¾ `/usr/local/website/` ä¸‹é¢äº†

### 13.1 pm2
ä½¿ç”¨ pm2ï¼Œå¯ä»¥åœ¨æœ¬æœºæµ‹è¯•ï¼Œä½†æ˜¯æœ€ç»ˆéƒ¨ç½²è¿˜æ˜¯æœåŠ¡å™¨
```
yarn global add pm2
```

ç»ˆç«¯è¿›å…¥é¡¹ç›®ç›®å½•ä¸‹ï¼Œç„¶åï¼š
#### å…¨å‘½ä»¤
```
pm2 start yarn --name "next-test" -- run start
```

#### è„šæœ¬
é¡¹ç›®æ ¹ç›®å½•ä¸‹ deploy.shï¼š
```sh
#deploy.sh
pm2 start yarn --name "next-test" -- run start
```

ç»ˆç«¯è¿›å…¥é¡¹ç›®ç›®å½•ä¸‹ï¼š
```
. deploy.sh 
```

![](../static/images/next-js-13.1.png)

å‡ ä¸ª pm2 å‘½ä»¤ï¼š
* pm2 show [id]: æ˜¾ç¤ºæŸä¸ª pm2 åº”ç”¨çš„ä¿¡æ¯
* pm2 list: æ˜¾ç¤ºæ‰€æœ‰çš„ pm2 åº”ç”¨çš„æ¦‚è§ˆ
* pm2 stop [id]/all: åœæ­¢æŸä¸ªåº”ç”¨ï¼Œå¯ä»¥å¤šä¸ªåˆ é™¤ï¼Œç©ºæ ¼éš”å¼€æˆ–è€…å…¨éƒ¨åœæ­¢
* pm2 delete [id]/all: åˆ é™¤æŸä¸ªåº”ç”¨ï¼Œå¯ä»¥å¤šä¸ªåˆ é™¤ï¼Œç©ºæ ¼éš”å¼€æˆ–è€…å…¨éƒ¨åˆ é™¤
* pm2 monit: ç›‘å¬ pm2 å¯åŠ¨çš„åº”ç”¨çŠ¶æ€
* pm2 restart: é‡å¯
* ç­‰ç­‰

### 13.2 Nginx 
pm2 æœåŠ¡è¿è¡Œç¨‹åºï¼Œnginx è´Ÿè´£å¼€å¯ http æœåŠ¡ï¼Œè¿™é‡Œåªæ˜¯ç®€å•çš„ä½¿ç”¨

#### å‡ ä¸ª nginx å‘½ä»¤
* nginx: å¯åŠ¨ nginx
* nginx -t: æµ‹è¯• nginx.conf é…ç½®æ˜¯å¦æ­£ç¡®
* nginx -s stop: åœæ­¢ nginx
* nginx -s reload: é‡å¯ nginx 
* ç­‰ç­‰

#### åœ¨æœ¬åœ°æµ‹è¯•çš„é…ç½®ï¼ˆmac)
> ç½‘ç«™ä»£ç éƒ½æ”¾ `/usr/local/website` ä¸‹

nginx.conf é…ç½®ï¼š
```nginx

#user  nobody;
worker_processes  1;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;


events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
    #                  '$status $body_bytes_sent "$http_referer" '
    #                  '"$http_user_agent" "$http_x_forwarded_for"';

    #access_log  logs/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  65;

    gzip  on;

    upstream next-test {
	    server 127.0.0.1:3000; # next-test å¯åŠ¨çš„æœåŠ¡ç«¯å£
    }

    # next-test
    server {
        listen       80;
        server_name  localhost; #è¿™é‡Œé…ç½®åŸŸå

        #charset koi8-r;

        #access_log  logs/host.access.log  main;

        error_page  404              /404.html;

        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }

        location / {
            proxy_pass http://127.0.0.1:3000; #è¯·æ±‚å°†ä¼šè½¬å‘åˆ°next-testçš„nodeæœåŠ¡ä¸‹
            proxy_redirect off;
            
            # root   html;
            index  index.html index.htm;
        }
    }

    # movie-db: å•é¡µé¢SPA
    server {
        listen       81;
        server_name  localhost; #è¿™é‡Œé…ç½®åŸŸå

        root /usr/local/website/movie-db/;

        location / {
            try_files $uri $uri/ @router;
        }

        location @router {
            rewrite ^.*$/index.html last;
        }

        # error_page  404              /404.html;

        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }


    # HTTPS server
    #
    #server {
    #    listen       443 ssl;
    #    server_name  localhost;

    #    ssl_certificate      cert.pem;
    #    ssl_certificate_key  cert.key;

    #    ssl_session_cache    shared:SSL:1m;
    #    ssl_session_timeout  5m;

    #    ssl_ciphers  HIGH:!aNULL:!MD5;
    #    ssl_prefer_server_ciphers  on;

    #    location / {
    #        root   html;
    #        index  index.html index.htm;
    #    }
    #}
    include servers/*;
}
```

## åç»­è¦æçš„ä¸œè¥¿
### æ•°æ®åº“
MySQL/MongoDB è¿™ä¸¤ä¸ªå§

### GrahpQL
å¥½åƒå« **APIæŸ¥è¯¢è¯­è¨€**ï¼Œä¸»è¦åšæ¥å£èšåˆçš„ä¸€ä¸ªä¸œè¥¿å§ï¼›ä¸ºçš„æ˜¯å¯¹ åç«¯å¾®æœåŠ¡æ¥å£çš„èšåˆï¼Œç„¶åå‰ç«¯é¡µé¢åªè¦è¯·æ±‚ **ç»è¿‡èšåˆçš„æ¥å£**ï¼Œå°±ä¸éœ€è¦å¤šæ¬¡è¯·æ±‚ **åç«¯å¾®æœåŠ¡å°æ¥å£** äº†ï¼›ä¸çŸ¥é“ç†è§£çš„å¯¹ä¸å¯¹


## ä¸€äº›é—®é¢˜
*  ä»ä¸€çº§è·¯ç”±è¿›å…¥äºŒçº§è·¯ç”±ç„¶ååˆ·æ–°ï¼Œæµè§ˆå™¨åé€€ï¼ŒURLå˜äº†ä½†æ˜¯å†…å®¹ä¸å˜ï¼è¿™æ˜¯ä¸ª bug, [issues#9378](https://github.com/zeit/next.js/issues/9378), [è§£å†³](https://github.com/zeit/next.js/pull/9380)

* åœ¨æŸäº›è·¯ç”±åˆ·æ–°åï¼Œè¿›å…¥å…¶ä»–è·¯ç”±å¯¼è‡´æ ·å¼ä¸¢å¤±ï¼ŒæŸ¥çœ‹è¯·æ±‚ `styles.chunk.css` å¹¶æ²¡æœ‰ç›¸å…³çš„ cssï¼Œä½†æ˜¯ `scss+css modules` å€’æ˜¯è½¬åŒ–å¥½äº†ï¼ˆè²Œä¼¼åªè¦å¼€å‘ç¯å¢ƒä¼šï¼Œæ‰“åŒ…åæ²¡é‡åˆ°è¿‡ï¼‰

* next.js ä½¿ç”¨ koa å¥½åƒæœ‰ç‚¹é—®é¢˜ï¼ŒæœåŠ¡ç«¯æ¸²æŸ“çš„é¡µé¢çœ‹ç½‘ç»œè¯·æ±‚é‚£é‡Œä¼šæ˜¯ 404ï¼Œä½†æ˜¯é¡µé¢æ¸²æŸ“å‡ºæ¥äº†ï¼›è¦ä¹ˆå°±æ˜¯åŠ¨æ€è·¯ç”±(`/detail/:id`) 404ã€‚ã€‚ã€‚å•ç‹¬ä½¿ç”¨ koa æ­å»ºçš„ node.js æœåŠ¡å¹¶ä¸ä¼šæœ‰è¿™æ ·çš„é—®é¢˜( [è¿™é‡Œ](https://github.com/zero9527/mdnote-service) )

<!--* åŸæœ¬ æ¥å£éƒ¨åˆ†ä¹Ÿæ˜¯è¦ç”¨ Typescript çš„ï¼Œé‡åˆ°ä¸€ç‚¹é—®é¢˜ï¼Œæš‚æ—¶å°±ä¸åŠ äº†-->


## å‚è€ƒ
* æ–‡æ¡£ [nextjs.org](https://nextjs.org/docs)
* è¿˜æœ‰ç½‘ä¸Šä¸€äº›å¤§ä½¬çš„æ–‡ç« 
